# 开发者指南

本章节详细展示开发者如何搭建完整的开发环境、验证算子接口/算法的有效性，以及提交Issue和PR到MindIE SD仓。

## 构建指导<a name="section6420926145710"></a>

本章节介绍如何在物理机上搭建完整的开发环境，包含驱动固件、CANN、PyTorch、Torch NPU、MindIE SD（安装包安装&源码编译）安装方式，以及MindIE SD卸载&更新方式。

1. 安装驱动固件

下载配套的昇腾NPU驱动和固件、CANN软件包并进行安装。

宿主机如未安装过NPU驱动和固件，请参见《CANN 软件安装指南》中的“选择安装场景”章节或“选择安装场景”章节（社区版），根据安装方式、操作系统、业务场景选择安装场景，选择完成后单击“开始阅读”，按“**安装NPU驱动和固件**”章节进行安装。

-   安装方式：选择“在物理机上安装”。
-   操作系统：选择使用的操作系统，MindIE支持的操作系统请参考《MindIE安装指南》中的2-[硬件配套和支持的操作系统]。
-   业务场景：选择“训练&推理&开发调试”。

2. 安装CANN

请参见《CANN 软件安装指南》中的“选择安装场景”章节或“选择安装场景”章节（社区版），根据安装方式、操作系统、业务场景选择安装场景，选择完成后单击“开始阅读”，按“**安装CANN（物理机场景） \> 安装CANN软件包**”章节进行安装。

-   安装方式：选择“在物理机上安装”。
-   操作系统：选择使用的操作系统。
-   业务场景：选择“训练&推理&开发调试”。

共需安装以下软件包：

-   CANN Toolkit开发套件包
-   CANN Kernels算子包
-   CANN NNAL神经网络加速库（可选）

>![](../public_sys-resources/icon-note.gif) **说明：** 
>如果需要使用MindIE SD量化功能时，则必须安装CANN软件包NNAL神经网络加速库的Python库，即安装CANN软件包NNAL神经网络加速库时需添加**--torch\_atb**参数进行指定，且运行时确保已安装Kernels算子包。安装命令如下所示：
>```
>./Ascend-cann-nnal_<version>_linux-<arch>.run --install --torch_atb
>```

3. 安装PyTorch和Torch NPU

详情请参见《MindIE安装指南》中的“安装MindIE \> 方式二：物理机安装方式”章节，下载配套版本并进行安装。

-   PyTorch框架whl包（支持版本为：2.1.0）
-   torch\_npu插件whl包

4. 安装其他环境依赖

-   根据Modelers/Modelzoo仓上模型README，进行相关依赖的安装。

```
pip install -r requirements.txt
```

-   安装gcc、g++

若镜像环境中没有gcc、g++，请用户自行安装，并导入头文件路径

```
yum install gcc g++ -y
export CPLUS_INCLUDE_PATH=/usr/include/c++/12/:/usr/include/c++/12/aarch64-openEuler-linux/:$CPLUS_INCLUDE_PATH
```

5. 安装MindIE SD

方式一：安装包安装

MindIE SD无需单独安装，安装MindIE时，MindIE SD将自动安装。MindIE推理引擎软件包的安装详情请参见《MindIE安装指南》中的“安装MindIE \> 方式二：物理机安装方式 \> 安装MindIE软件包”章节。

初始化环境变量，MindIE安装路径下有环境变量设置脚本“set\_env.sh“，默认路径为/usr/local/Ascend/mindie，用户需根据实际安装路径进行环境变量配置。

```
source /usr/local/Ascend/mindie/set_env.sh
```

输入以下命令验证是否安装成功：

```
python3 -c “import torch, torch_npu,mindiesd"
```

方式二：源码编译安装

1）代码仓下载代码

git clone  [https://gitcode.com/Ascend/MindIE-SD.git](https://gitcode.com/Ascend/MindIE-SD.git)

2）编译安装

安装依赖：

yum install cmake -y

执行命令编译：

cd MindIE-SD/build

bash build.sh

编译成功后MindIE-SD/output目录下会有Ascend-mindie-sd\_$\{MindIESDVersion\}\_$\{PYTHON\_VERSION\}\_linux\_$\{ARCH\}.tar.gz，进行解压：

tar -zxvf Ascend-mindie-sd\_$\{MindIESDVersion\}\_$\{PYTHON\_VERSION\}\_linux\_$\{ARCH\}.tar.gz

解压后的目录有四个文件：

-   mindiesd-1.0rc1-py3-none-any.whl，MindIE-SD的pip安装包
-   aie\_ops.run，算子部署包
-   requiememts.txt
-   set\_env.sh

运行以下命令安装MindIE-SD：

pip install  mindiesd-1.0rc1-py3-none-any.whl

3）算子部署

方式一：设置自定义算子环境变量为当前编译路径

current\_script\_dir=MindIE-SD/build export ASCEND\_CUSTOM\_OPP\_PATH=$\{current\_script\_dir\}/pkg/vendors/customize:$\{current\_script\_dir\}/pkg/vendors/aie\_ascendc:

方式二：算子部署在MindIE-SD安装路径下

运行以下命令将算子部署在MindIE-SD的安装路径下并设置自定义算子路径的环境变量

dst=/usr/local/lib/python3.11/site-packages/mindiesd/ops

bash aie\_ops.run --extract=$\{dst\}

export ASCEND\_CUSTOM\_OPP\_PATH=$\{dst\}/vendors/customize:$\{dst\}/vendors/aie\_ascendc:$ASCEND\_CUSTOM\_OPP\_PATH

5. 卸载MindIE SD

可通过以下命令卸载MindIE SD：

pip uninstall mindiesd

rm -rf $\{旧mindiesd的安装路径\}/ops

卸载后，可提供下载新版本安装包的方式/源码编译的方式更新MindIE SD。

## 自测方法<a name="section6665639165712"></a>

本章节介绍MindIE SD仓算子自测方式，看护算子精度。

1）运行全量UT测试用例：

pip install -r MindIE-SD/requirements.txt

pip install coverage

cd MindIE-SD/tests

bash run\_test.sh

2）运行LA单算子精度测试用例

修改MindIE-SD/tests/plugin/la\_acc\_prof.py文件，选择Option 1或Option 2，通过加载test\_la.csv或enumerated\_cases.csv文件，测试LA算子在所设置shape下的精度。

-   "./tests/plugin/test\_la.csv"：设置了常用SD模型的输入shape
-   "enumerated\_cases.csv"：枚举的各种shape

完成修改后运行以下命令：

cd MindIE-SD/

python tests/plugin/la\_acc\_prof.py

运行成功后会在MindIE-SD目录下保存两个结果文件acc\_output\_results\_1.csv、acc\_output\_results\_1.csv，记录了la和fascore的相似度，可查看算子在所需shape下的精度。
